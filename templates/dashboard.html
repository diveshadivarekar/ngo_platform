{% extends 'base.html' %}

{% block title %}Impact Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h1>NGO Impact Dashboard</h1>
    <p class="subtitle">From Data Chaos to Narrative Clarity. Visualize, filter, and export the impact of NGOs.</p>
</div>

<!-- Map and Controls -->
<div class="dashboard-main">
    <div class="map-container">
        <h2>Geographical Overview</h2>
        <div id="impact-map"></div>
    </div>
    <div class="controls-container">
        <h2>Filter & Export</h2>
        <form class="filters-form" method="get" action="{{ url_for('dashboard') }}">
            <div class="filter-group">
                <label for="area">Filter by Area:</label>
                <select name="area" id="area" onchange="this.form.submit()">
                    <option value="all" {% if selected_area == 'all' %}selected{% endif %}>All Areas</option>
                    {% for area in unique_areas %}
                    <option value="{{ area }}" {% if selected_area == area %}selected{% endif %}>{{ area }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="year">Filter by Year Founded:</label>
                <select name="year" id="year" onchange="this.form.submit()">
                    <option value="all" {% if selected_year == 'all' %}selected{% endif %}>All Years</option>
                    {% for year in unique_years %}
                    <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
        <a href="{{ url_for('export_csv') }}" class="export-button">Export as CSV</a>
    </div>
</div>


<!-- NGO Cards Grid -->
<div class="ngo-grid">
    {% for ngo in ngos %}
    <div class="ngo-card">
        <div class="card-header">
            <h3><a href="{{ url_for('ngo_profile', slug=ngo.slug) }}">{{ ngo.name }}</a></h3>
            <span class="ngo-area">{{ ngo.area }}</span>
        </div>
        <div class="card-body">
            {% if ngo.goal and ngo.goal.target > 0 %}
                {% set progress = ((ngo.impact[ngo.goal.metric] / ngo.goal.target * 100) | round | int) %}
                <div class="goal-progress">
                    <p class="progress-label"><strong>Goal:</strong> {{ ngo.goal.target }} {{ ngo.goal.metric }}</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                        <div class="progress" style="width: {{ progress }}%;"></div>
                    </div>
                    </div>
                </div>
                <br>
            {% else %}
                 <p class="no-goal">No specific goal set.</p>
            {% endif %}
        </div>
        <div class="card-footer">
            <div class="sdg-icons">
                 {% for code in ngo.sdg %}
                    <img src="https://img.shields.io/badge/SDG-{{ code }}-{{ sdg_colors[code] }}.svg" alt="SDG {{code}}" title="SDG {{code}}: {{ sdg_titles[code] }}">
                {% endfor %}
            </div>
            <span class="founded-year">Founded: {{ ngo.start_date.split('-')[0] }}</span>
        </div>
    </div>
    {% else %}
    <p class="no-results">No NGOs match the current filters. Try clearing them to see all organizations.</p>
    {% endfor %}
</div>


<!-- Hidden data for JavaScript -->
<script id="ngo-data" type="application/json">
    {{ ngos | tojson }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dataEl = document.getElementById('ngo-data');
        if (dataEl && dataEl.textContent) {
            try {
                const ngos = JSON.parse(dataEl.textContent);
                if (ngos.length > 0) {
                    const map = L.map('impact-map').setView([ngos[0].location.lat, ngos[0].location.lon], 7);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    ngos.forEach(ngo => {
                        if (ngo.location && ngo.location.lat && ngo.location.lon) {
                            L.marker([ngo.location.lat, ngo.location.lon]).addTo(map)
                                .bindPopup(`<b>${ngo.name}</b><br>${ngo.area}<br><a href="/ngo/${ngo.slug}">View Details</a>`);
                        }
                    });
                } else {
                     document.getElementById('impact-map').innerHTML = '<p style="padding: 20px; text-align: center;">No geographical data to display for current filters.</p>';
                }

            } catch (e) {
                console.error("Error parsing NGO JSON data:", e);
                document.getElementById('impact-map').innerHTML = '<p style="padding: 20px; text-align: center; color: red;">Error loading map data.</p>';
            }
        } else {
             console.log("No NGO data element found for map.");
             document.getElementById('impact-map').innerHTML = '<p style="padding: 20px; text-align: center;">No map data available.</p>';
        }
    });
</script>
{% endblock %}

